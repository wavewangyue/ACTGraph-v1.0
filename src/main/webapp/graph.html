<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>KnowledgeGraph v1.0</title>
    <script src="js/ex/echarts.js"></script>
    <script src="js/ex/dark.js"></script>
    <script src="js/ex/jquery-3.1.1.min.js"></script>
    <script src="js/ex/d3.min.js"></script>
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
</head>

<style>
    html,body{ 
        margin:0px; 
        height:100%;
    }
    body{
        background-color:#060A0E;
    }
    .talkbar{
        position:absolute;
        width:30%;
        height:100%;
        margin-left:70%;
        padding: 5em;
        text-align: right;
        display:none;
    }
    .talkbubble{
        margin:0 auto;
        padding: 1em;
        font-size: 1.5em;
        font-family: 微软雅黑;
    }
    #talkinput{
        font-size: 1.5em;
        font-family: 微软雅黑;
        text-align:center;
        padding:0.5em;
        -moz-border-radius: 10px;
        -webkit-border-radius: 10px;
        border-radius:10px;
        margin-top:2%;
    }
</style>

<body onload="init()" onkeydown="if(event.keyCode==27) talkboxshow()">

    <div id="panel" style="position:absolute;width:100%;height:100%;display:none"></div>

    <div class="talkbar" >
        <div class="talkbubble" style="color:#F08080">有什么可以帮你的？</div>
        <input id="talkinput" type="text" onkeydown="if(event.keyCode==13) talk()"/>
    </div>

    <div id="inputbox" class="input-group input-group-lg" style="padding-top:25%;width:30%;margin:0 auto" >
        <input id="input" type="text" class="form-control" style="text-align:center" value="北京航空航天大学" onkeydown="if(event.keyCode==13) graphinit()"/>
        <span class="input-group-addon" style="cursor:pointer" onclick="graphinit()">Graph Go!</span>
    </div>

</body>

<script type="text/javascript">

    var myChart;
    var nodes = [];
    var links = [];
    var categories = [];
    var answerpath = [];
    var nodeSize = 50;
    var dnodeSize = 8;
    var fontSize = 15;

    function init(){

    }

    //获取根目录路径
    function getRootPath(){
        var curWwwPath=window.document.location.href;
        var pathName=window.document.location.pathname;
        var pos=curWwwPath.indexOf(pathName);
        var localhostPath=curWwwPath.substring(0,pos);
        var projectName=pathName.substring(0,pathName.substr(1).indexOf('/')+1);
        return(localhostPath+projectName);
    }

    function talkboxshow(){
        $(".talkbar").fadeToggle();
    }

    function talk(){
        var question = document.getElementById("talkinput").value;
        while (question.charAt(0) == " ") question = question.substring(1);
        if (question!="") {
            d3.select("#talkinput").remove();
            d3.select(".talkbar").append("div")
                    .attr("class","talkbubble")
                    .style("color","lightblue")
                    .text(question);
            var url = getRootPath()+"/easyQA/talk.do?question="+question;
            $.getJSON(url, function(result){
            //$.getJSON("json/demo.json", function(result){
                var answer;
                if (result.nodes){
                    answer = result.answer;
                    $('#inputbox').fadeOut();
                    $('#panel').fadeIn();
                    myChart = echarts.init(document.getElementById('panel'),'dark');
                    refresh(question, result);
                }else{
                    answer = result;
                }
                d3.select(".talkbar").append("div")
                        .attr("class", "talkbubble")
                        .style("color", "#F08080")
                        .text(answer);
                d3.select(".talkbar").append("input")
                        .attr("id", "talkinput")
                        .attr("type", "text")
                        .on("keypress", function () {
                            if (d3.event.charCode == 13) talk();
                        });
                $("#talkinput").focus();
            });
        }
    }

    function graphinit(){

        var keyword = document.getElementById("input").value;
        while (keyword.charAt(0) == " ") keyword = keyword.substring(1);
        if (keyword!="") {
            $('#inputbox').fadeOut();
            $('#panel').fadeIn();
            myChart = echarts.init(document.getElementById('panel'),'dark');
            getNewData(keyword);
        }

    }

    function getNewData(keyword){

        myChart.showLoading({
            text: '',
            color: 'GreenYellow',
            maskColor: 'rgba(255, 255, 255, 0.3)',
            zlevel: 0
        });
        var url = getRootPath()+"/graphQA/answering.do?keyword="+keyword;
        //$.getJSON("json/demo.json", function(result){
        $.getJSON(url, function(result){
            refresh(keyword,result);
        });
    }

    //刷新绘图页面
    function refresh(keyword,result){

        answerpath = result.answerpath;
        var category_names = [];
        myChart.hideLoading();
        result.nodes.forEach(function(node){
            if ($.inArray(node.category,categories) < 0){
                category_names.push(node.category);
                categories.push({
                    name: node.category
                });
            }
            node.symbol = 'circle';
            node.symbolSize = nodeSize-node.value*dnodeSize;
            node.x = null;
            node.y = null;
            node.itemStyle = null;
            node.label = {
                normal: {
                    show: true,
                    position: 'right'
                }
            };
            nodes.push(node);
        });
        result.links.forEach(function(edge){
            links.push(edge);
        });
        //点亮寻找的答案轨迹
        nodes.forEach(function(node){
            if ($.inArray(node.id,answerpath) >= 0)
                node.itemStyle = {
                    normal: {
                        borderColor:'GreenYellow',
                        borderWidth:5
                    }
                };
        });
        links.forEach(function(link){
            if (($.inArray(link.source,answerpath)>=0)&&($.inArray(link.target,answerpath)>=0))
                link.lineStyle = {
                    normal: {
                        color: 'GreenYellow',
                        width: 5,
                    }
                };
        });
        //开始绘制图像
        var option = {
            title: {
                text: keyword,
                bottom: '10%',
                right: '10%',
                textStyle:{
                    color:"GreenYellow",
                    fontSize: fontSize*1.5
                }
            },
            tooltip: {
                formatter: function (params) {
                    return params.data.name;
                }
            },
            legend:[{
                data: categories,
                bottom: '10%',
                left: '10%',
                orient: 'vertical',
                itemGap: 20,
                selectedMode:false,
                textStyle:{
                    color:'gray'
                }
            }],
            series:[{
                type: 'graph',
                layout: 'force',
                data: nodes,
                links: links,
                categories: categories,
                lineStyle: {
                    normal: {
                        color: 'source',
                        width: 2,
                        curveness: 0.2
                    }
                },
                force: {
                    repulsion: 800,
                    layoutAnimation: false
                },
                roam: true,
                focusNodeAdjacency: true,
                animationDuration: 1500
            }],
            textStyle: {
                fontFamily: '微软雅黑',
                fontSize: fontSize
            },
        };
        myChart.setOption(option);
        myChart.on('click', function (event) {
            console.log(event);
        });
    }

</script>

</html>
